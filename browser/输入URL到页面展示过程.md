# 从输入URL到页面展示的过程

![流程图](https://static001.geekbang.org/resource/image/92/5d/92d73c75308e50d5c06ad44612bcb45d.png)

页面展示需要涉及到最少四个进程

1. 浏览器进程
2. 网络进程
3. 渲染进程
4. GPU进程
5. 插件进程（若需要执行插件则有该进程）

用户发出URL请求到页面开始解析的这个过程，就叫做导航。

整个流程：

1. 用户输入网址（浏览器主进程）
2. 浏览器构建请求，若输入无协议，浏览器自动添加协议。或者是搜索内容（浏览器主线程）
3. 判断浏览器本地是否有该网址的缓存，有则不需要请求，直接使用缓存数据。（网络主线程）
4. 网络请求通过查询本地DNS缓存看是否有该网址的IP:PORT，有则直接使用IP和端口，无则通过DNS请求查询IP端口。（网络进程）
5. 获取IP端口后进行网络请求，首先三次握手进行tcp链接。链接之后进行http请求，最后服务器响应数据返回给浏览器（网络进程）
6. 获取数据之后通过进程通信（IPC）将数据交给渲染进程。
7. 渲染进程获取数据之后从头开始解析文件将获取dom树和cssom树，将两者组合生成render树。
8. 渲染进程根据render树对每个节点的计算位置等，将节点布局到对应到位置上，并且根据render树数据进行绘制元素。

<https://blog.poetries.top/browser-working-principle/guide/part1/lesson04.html#_1-%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5>

我理解错误点：

1. 实际上实在网络进程中判断是否有缓存。
2. 若有缓存是直接返回给浏览器进程。浏览器进程发出“提交文档”消息，渲染进程收到“提交文档”消息之后，会和网络进程建立传输数据的“管道”。等文档数据传输完成之后，渲染进程会返回“确认提交”等消息给浏览器进程。浏览器进程在收到“确认提交”信息之后，会更新浏览器界面状态，如安全状态，地址了URL，前进后退的历史状态，并更新web页面。

## 总结：从输入URL到页面展示，这中间发生了什么

- 用户输入url并回车
- 浏览器进程检查url，组装协议，构成完整的url
- 浏览器进程通过进程间通信（IPC）把url请求发送给网络进程
- 网络进程接收到url请求后检查本地缓存是否缓存了该请求资源，如果有则将该资源返回给浏览器进程
- 如果没有，网络进程向web服务器发起http请求（网络请求），请求流程如下：
  - 进行DNS解析，获取服务器ip地址，端口（端口是通过dns解析获取的吗？这里有个疑问）
  - 利用ip地址和服务器建立tcp连接
  - 构建请求头信息
  - 发送请求头信息
  - 服务器响应后，网络进程接收响应头和响应信息，并解析响应内容
- 网络进程解析响应流程；
  - 检查状态码，如果是301/302，则需要重定向，从Location自动中读取地址，重新进行第4步 （301/302跳转也会读取本地缓存吗？这里有个疑问），如果是200，则继续处理请求。
  - 200响应处理：检查响应类型Content-Type，如果是字节流类型，则将该请求提交给下载管理器，该导航流程结束，不再进行后续的渲染，如果是html则通知浏览器进程准备渲染进程准备进行渲染。
- 准备渲染进程
  - 浏览器进程检查当前url是否和之前打开的渲染进程根域名是否相同，如果相同，则复用原来的进程，如果不同，则开启新的渲染进程
- 传输数据、更新状态
  - 渲染进程准备好后，浏览器向渲染进程发起“提交文档”的消息，渲染进程接收到消息和网络进程建立传输数据的“管道”
  - 渲染进程接收完数据后，向浏览器发送“确认提交”
  - 浏览器进程接收到确认消息后更新浏览器界面状态：安全、地址栏url、前进后退的历史状态、更新web页面
