# javaScript执行过程

全面分析js引擎的执行过程，分为三个阶段

1、语法分析
2、预编译阶段
3、执行阶段

说明：浏览器先按照js的顺序加载```<script>```标签分隔的代码块，js代码块加载完毕之后，立刻进入到上面的三个阶段，然后再按照顺序找下一个代码块，再继续执行三个阶段，无论是外部脚本文件（不异步加载）还是内部脚本代码块，都是一样的，并且都在同一个全局作用域中。

## 语法分析

js的代码加载完成之后，会首先进入语法分析阶段，该阶段的作用：
分析js代码的语法是否正确，如果错误则抛出个错误（synctaxError）,停止代码的执行，然后继续查找并加载下一个代码块。如果语法分析正确，则进入预编译阶段。
语法错误如图：
![语法报错](https://www.mwcxs.top/static/upload/pics/2019/1/7mAWoi2mhsC1ERUv-8suJB6Tm.png)

## 预编译阶段

js代码块通过语法分析阶段之后，语法都正确的下回进入预编译阶段。

在分析预编译阶段之前，我们先来了解一下js的运行环境，运行环境主要由三种：

1、全局环境（js代码加载完毕后，进入到预编译也就是进入到全局环境）
2、函数环境（函数调用的时候，进入到该函数环境，不同的函数，函数环境不同）
3、eval环境（不建议使用，存在安全、性能问题）

每进入到一个不同的运行环境都会创建 一个相应的执行上下文（execution context），那么在一段js程序中一般都会创建多个执行上下文，js引擎会以栈的数据结构对这些执行进行处理，形成函数调用栈（call stack），栈底永远是全局执行上下文（global execution context），栈顶则永远时当前的执行上下文。

### 预编译什么时候发生

预编译分为全局预编译和局部预编译，全局预编译发生在页面加载完成时执行，而局部预编译发生在函数执行的前一刻。即：**局部预编译阶段就是创建执行上下文的阶段**
> tip：预编译阶段发生变量声明和函数声明，没有初始化行为（赋值）-- （也就是执行上下文的创建过程），匿名函数不参与预编译 。只有在解释执行阶段才会进行变量初始化 。
变量的初始化（赋值）行为就是在创建执行上下文的执行过程完成的。

### 预编译过程

全局预编译3个步骤

1. 创建GO对象，全局对象。
2. 找到变量声明，将变量名作为GO对象到属性，值赋予undefined
3. 找到函数声明，作为GO的属性，值赋予函数体。

局部预编译4个步骤

1. 创建AO对象执行期上下文。
2. 找形参和变量的声明，将变量和形参名作为AO的属性，赋值为undefined
3. 形参和实参对应统一。
4. 找到函数声明，作为AO属性，赋予函数体。

> tip：GO对象是全局预编译，所以它优先于AO对象所创建和执行

## 执行阶段

本文主要分析js引擎执行的第三个阶段–执行阶段，在分析之前我们先思考以下两个问题：

1、js是单线程的，为了避免代码解析阻塞使用了异步执行，那么它的异步执行机制是怎么样的？

答：通过事件循环（Event Loop），理解了事件循环的原理就理解了js的异步执行机制，本文主要介绍。

2、js是单线程的，那么是否代表参与js执行过程的线程就只有一个？

答：不是的，会有四个线程参与该过程，但是永远只有JS引擎线程在执行JS脚本程序，其他的三个线程只协助，不参与代码解析与执行。参与js执行过程的线程分别是：

（1）**JS引擎线程：** 也称为JS内核，负责解析执行Javascript脚本程序的主线程（例如V8引擎）。

（2）**事件触发线程：** 归属于浏览器内核进程，不受JS引擎线程控制。主要用于控制事件（例如鼠标，键盘等事件），当该事件被触发时候，事件触发线程就会把该事件的处理函数推进事件队列，等待JS引擎线程执行。

（3）**定时器触发线程：** 主要控制计时器setInterval和延时器setTimeout，用于定时器的计时，计时完毕，满足定时器的触发条件，则将定时器的处理函数推进事件队列中，等待JS引擎线程执行。

注：W3C在HTML标准中规定setTimeout低于4ms的时间间隔算为4ms。

（4）**HTTP异步请求线程：** 通过XMLHttpRequest连接后，通过浏览器新开的一个线程，监控readyState状态变更时，如果设置了该状态的回调函数，则将该状态的处理函数推进事件队列中，等待JS引擎线程执行。

注：浏览器对同一域名请求的并发连接数是有限制的，Chrome和Firefox限制数为6个，ie8则为10个。

总结：永远只有JS引擎线程在执行JS脚本程序，其他三个线程只负责将满足触发条件的处理函数推进事件队列，等待JS引擎线程执行。

> 执行过程其实就是之前学习涉及到执行栈，同步任务，异步任务，宏任务，微任务，事件循环等知识。

```js
// 预编译过程

// 1、生成一个活动对象AO
// 2、形参，作为AO对象赋值为undefined，形参实参相统一，未传入的形参还是undefined
// 3、找变量声明，作为对象AO属性，赋值为undefined
// 4、找函数声明，作为对象AO属性，赋值为函数体
```
